
%%%%%%%%%%%%%%%%%%%%%%% file typeinst.tex %%%%%%%%%%%%%%%%%%%%%%%%%
%
% This is the LaTeX source for the instructions to authors using
% the LaTeX document class 'llncs.cls' for contributions to
% the Lecture Notes in Computer Sciences series.
% http://www.springer.com/lncs       Springer Heidelberg 2006/05/04
%
% It may be used as a template for your own input - copy it
% to a new file with a new name and use it as the basis
% for your article.
%
% NB: the document class 'llncs' has its own and detailed documentation, see
% ftp://ftp.springer.de/data/pubftp/pub/tex/latex/llncs/latex2e/llncsdoc.pdf
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\documentclass[runningheads,a4paper]{llncs}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{graphicx}

\usepackage{url}
\urldef{\mailsa}\path|{caldwelt, david.t.coleman, nikolaus.correll}@colorado.edu|    
\newcommand{\keywords}[1]{\par\addvspace\baselineskip
\noindent\keywordname\enspace\ignorespaces#1}

\usepackage{color}
\usepackage{wrapfig}


\begin{document}

\mainmatter  % start of an individual contribution

% first the title is needed
\title{Robotic Manipulation for Identification of Flexible Objects}

% a short form should be given in case it is too long for the running head
\titlerunning{Robotic Manipulation for Identification of Flexible Objects}


\author{T. M. Caldwell and  D. Coleman and N. Correll%
\thanks{
This work was supported by a NASA
Early Career Faculty fellowship NNX12AQ47GS02. We are grateful for this support.}%
}
%
\authorrunning{Robotic Manipulation for Identification of Flexible Objects}
% (feature abused for this document to repeat the title also on left hand pages)

% the affiliations are given next; don't give your e-mail address
% unless you accept that it will be published
\institute{Department of Computer Science, University of Colorado,\\
1111 Engineering Dr, Boulder, CO 80309, USA\\
\mailsa}

\toctitle{Lecture Notes in Computer Science}
\tocauthor{Authors' Instructions}
\maketitle

\begin{abstract}
Blah
\end{abstract}

\section{Introduction}

\begin{figure}[!htb]
\centering
\def\svgwidth{.95\textwidth}%500pt}
\input{baxter_y.pdf_tex}
\caption{The physical experiment, vision capture (in green), and simulation of baxter manipulating a flexible object. The vision capture is shown in MoveIt! and the simulation is done in \texttt{trep}.}
\label{fig-baxter_y}
\end{figure}

\section{Example Experiment Setup}
The goal of the example experiment is to first identify dynamic properties of a flexible obect and to second use the identified model for trajectory planning. The flexible object is shaped like the letter `Y'.  It is supposed to resemble a potential geometry of a plant. The base, or `trunk' is attached to the ground and is labelled $T_1$. The robot has the end of one branch grasped. This branch is labelled $T_2$.  The other branch is not reachable by the other arm and is labelled $T_3$. The ultimate goal is to manipulate the grasped branch so that the other branch enters the work space of the end effector of the free arm. Due to the flexibility of the object it is not immediately clear how to plan a manipulation that moves the free branch to the desired region. For this reason, we first conduct the parameter identification from \cite{caldwell_coleman_correll_iros} in order to identify a model.  Second, we use the optimal control technique from XXXX to calculate a path to move the tip of the free branch to a desired point in space.  We use vision to XXXX.

The flexible object is foam tubing with differing widths for each the trunk and the two branches. The three tubes are connected with a `Y' joint PVC and glue.  The trunk tube has length XXXX and mass XXX. It is the widest tube at XXXX. The grasped tube has length XXX and mass XX and is the second widest tube. The free tube has length XXX and mass XXX. It is the thinnest at XXXX.  The width is mentioned because we expect the relative twisting stiffnesses of each tube to correlate with their widths. 

We use Rethink Robotics' Baxter \cite{guizzo2011rethink} robot to both manipulate and measure the loop.  Each of Baxter's arms have 7 degrees of freedom.  The arms are designed for compliance since each joint has series elastic actuators that allows for force sensing and control.  Baxter can publish the joint angles and torques at 100Hz.  A picture of Baxter manipulating the flexible object is in Figure XXXXX. 

\section{Model and Simulation}
The flexible object is modeled using as a spring mass system. The trunk and branches are each approximated with four rigid links of uniform lengths and masses connected by joints with torsional springs. The joints are 3 dimensional modeling bending and twisting of the flexible object. In total, the flexible object is 36 dimensional. The goal of the identification, Section XXXX, is to identify the torsional springs' spring constants. We label these parameters as $\rho$.

Each of Baxter's arms are 7 degrees of freedom. Thus, the system of Baxter grasping one end of the flexible object---neglecting the other arm--- has a total number of 43 configuration variables. The dimensions,  inertia, and other information concerning Baxter's arm can be obtained at \url{https://github.com/RethinkRobotics}.  

\subsection{Simulation}
The model for both Baxter's arm and the flexible object are a series of rigid links connected by rotational joints. As such, the dynamics of both the manipulator and the object can be handled together. We use \emph{variational integrators} to simulate the system dynamics.   Variational integrators are a discrete-time representation of the equations of motion of a mechanical system.  They are designed from the least action principle and have good properties that agree with known physical phenomenon like stable energy behavior \cite{pekarek_murphey}.  

We will always simulate the system for a finite time interval $[0,t_f]$ for the times $t_0,t_1,\ldots,t_{k_f}$ where $t_0 = 0$, $t_{k_f} = t_f$ and $k_f+1$ is the total number of discrete times in the interval. The simulation---i.e. the solving of the system dynamics---will result in a state $x_k:=x(t_k)$.  For variational integrators, the state is composed of the configuration, labelled $q_k$ for time $t_k$, as well as a term labelled $p_k$, also for time $t_k$. For systems without external forcing, the second term is the conserved momentum.  For the purposes of this paper, it can simply be thought of as analagous to the time derivative of $q_k$, which is often paired with $q_k$ to make up the state.  Therefore, the state is $x_k:=[q_k,p_k]^T$. 

The literature on variational integrators \textbf{CITE XXXXXXXX} provides a one-step mapping to update the state at the previous time $x_k$ to the next time $x_{k+1}$.  We provide a short high-level review of variational integrators.  We write the one-step mapping which constitutes the systems equations of motion as 
\begin{equation}
x_{k+1} = f(x_k,\rho,t_k).
\label{eq-fk}
\end{equation}
Here, $f$ explicitely depends on the previous state, time, and the parameters which we wish to identify. For a single simulation, $\rho$ remains constant.  While we write the equations of motion as an explicit equation, the equations are in fact implicit and rely on root solving to update the state. 

The equations encapsulate the system's Lagrangian, any external forcing, holonomic constraints, as well as a choice of quadrature for approximating integrals.  The function $f$ can be linearized. We write 
\begin{equation}
A_k = \frac{\partial}{\partial x_k}f(x_k,\rho,t_k) \textrm{ and } B_k = \frac{\partial}{\partial \rho}f(x_k,\rho,t_k).
\label{eq-lin_fk}
\end{equation}
The equations to calculate the linearation with respect to the state and parameters can be found in \textbf{CITE IROS PAPER}. They are needed for calculating the gradient for parameter identification as part of an iterative optimization.

\subsection{Simulation of Example}
We use variational integrators to simulate Baxter manipulating the flexible object through the software tool \texttt{trep} \cite{johnson_murphey_scalable}.  The tool simulates articulated rigid bodies using midpoint variational integrators.  It additionally provides partial derivative calculations that we need for the system linearization, Eq.(\ref{eq-fk}). 

A single configuration of Baxter and the flexible object, $q_k$, is given by a configuration of dimension 43. Therefore, the system's state,  $x_k = [q_k,p_k]^T$, is 86 dimensional. The discrete dynamics given by $f$, Eq.(\ref{eq-fk}) is given by the discrete system Lagrangian, discrete external forcing, and holonomoic constraints---see cite IROS paper.  The system Lagrangian is specified by the kinetic and potential energies of Baxter and the object.  External forces enter the system through the motors at each of Baxter's joints.  Additionally, holonomic constraints are needed to ensure that Baxter's end effector remains in contact with the tip of the flexible object's gripped branch.  We choose a time step of $0.01$ seconds, which matches the broadcast frequency of Baxter. 

Nominally, the simulation will perfectly agree an Baxter's measured joint torque and angles for a given experiment. However, due to model and sensor disturbances, this will not be the case. Furthermore, since the system is unstable---i.e. small disturbances can result in large changes to trajectory---directly feeding the measured torques into the model will not result in a meaningful simulation. Therefore, the measured joint torques, labelled $\overline{T}$, and measured joint angles, labelled $\overline{b}$, must be filtered through a feedback loop. We use a simple proportional feedback loop with gain $K$: 
\[
T_k = \overline{T}_k - K_k (b_k - \overline{b}_k),
\]
where $T$ and $b$ as the filtered joint torques and angles.  When $K$ is too large, the effect of the parameters will be dominated by the control and the system can not be identified. However, if $K$ is too small, the system will remain unstable and not track the measured trajectory well enough to be meaningful.  Correctly choosing for the purposes of parameter identification of unstable systems is left for future work.  For this paper, we chose $K$ from a finite horizon LQR which results in an optimal feedback gain from the model linearized around $b_{meas}$ and a quadratic cost functional \cite{anderson_moore}.  The tradeoff between tracking the joint angles or joint torques is directly represented in the quadratic cost for specifying how large $K$ is.


\section{Vision}

For verification and improvement of the parameter identification algorithms, the plant model is visually tracked using an out of the box depth sensor, the Asus Xtion Pro. The depth sensor is positioned directly in front of the robot, viewing the Baxter and the flexible object. The processing of the acquired point clouds consists of three steps: filtering, segmentation, and graph creation. 

The motion planning framework MoveIt! \cite{moveit} is used to perform the first step of self-filtering for the point cloud data $G$, removing points detected on the robot’s body and arms. This is accomplished using the realtime joint states and calculated coordinate transforms to determine the robot’s configuration. The Point Cloud Library (PCL) \cite{rusu20113d} is used for the second level of filtering, removing points detected behind the robot and on the floor. Finally, a statistical outlier removal filter is used to remove noise and measurement errors.

The segmentation of the filtered point cloud $G_{filtered}$ is also accomplished using PCL. This step attempts to convert the long trunk and branches of the plant into segmented components that can later be turned into a graph. The lowest point in the point cloud on the z-axis (near the floor) detected is used to seed the algorithm. The $k_1$ nearest neighbors to this point is then chosen using a Kd Tree to represent a “segment” $s$ of the plant model. This segment is not typically centered with the plant trunk or branch’s center, so an additional centering step is required. The centroid of the $s$ is calculated and a second $k_1$ nearest neighbors search is performed to find a centered segment $s_{centered}$ at the base of the plant.

Assuming the number of points is above a minimum threshold (to remove noise), the centroid of $s_{centered}$ is now added to a processed graph $G_{processed}$. The points in $s_{centered}$ is finally removed from $G_{filtered}$. The next nearest neighbor to $s_{centered}$ is chosen as the new center point and the algorithm repeats. Occasionally, there will be no nearest neighbor to a segment if, for example, the algorithm has reached the end of one of the branches of the plant. In this case, a random point is chosen in the remaining point cloud $G_{filtered}$ until no further points remain.

The last vision tracking step takes the disconnected points in $G_{processed}$ and performs one final series of nearest neighbor searches to connect the nodes together to represent a flexible plant modeled as a series of connected rigid bodies. These connected rigid bodies give a surprisingly accurate three dimensional reconstruction of a flexible object in soft-realtime, processing new point clouds at a rate averaging 3 hz. XXXXXX TIM SAYS: ADD A FIGURE

\subsection{Fitting to Model}

The processed points in $G_{processed}$ need to be fitted to the model to be useful. The model is a discretization of the physical object where the flexible object’s configuration specifies the location of the discretization points. Label the object’s configuration as $q_o$. 

The fitting is a calculation on $q_o$ and is accomplished as follows: Let $G_{model}(q_o)$ be a graph specified for configuration $q_o$ with the discrete points as its vertices and adjacent points in the model as its edges. Any two adjacent points in $G_{model}(q_o)$ can be connected by a line segment in space. Let $L_{model}(q_o)$ be the collection of these line segments. Further, let $d(p,\ell)$ be the shortest distance in space between the point $p\in G_{processed}$ and line segment $\ell \in L_{model}(q_o)$. Set $d(p,L_{model}(q_o)) = \min_{\ell\in L_{model}(q_o)} d(p,\ell)$ as the least distance for $p$ from any line segment in $L_{model}(q_o)$. This can be done for each $p\in G_{processed}$. The fitting is given by the $q_o$ for which the points in $G_{processed}$ are nearest the line segments $L_{model}(q_o)$---i.e. by the optimization program
\begin{equation}
\arg \min_{q_0} \sum_{p\in G_{processed}} d(p,L_{model}(q_o)).
\label{eq-fit_prog}
\end{equation}

\subsection{Vision Tracking Concerns}

A number of tuned parameters make this algorithm sensitive to plant model size, the distance between the camera and the model, and variability of the thickness of the trunk and branches of the plant. However, it works well for our experimental goals in verification.

One major shortcoming of the vision tracking pipeline developed for this experiment was occasional choppiness and buffering issues. Because of the computational complexity of our flexible object manipulation pipeline, the experiment was run on 3 distributed commodity PCs using ROS \cite{quigley2009ros}. A common issue was clock time synchronization between the three PCs, and ROS messages being dropped because of full buffers. This caused the robot transforms to be published with old time stamps and the robot self-filtering of the point clouds to stall, ultimately resulting in choppiness in the visual tracking of the plant model. This is an area of continued investigation and improvement. 

\section{Identification}
The goal of the identification is to calculate model parameters of the system that best agree with the physical behavior of the physical object. For the example in the paper, the parameters we wish to identify are the spring constants of the flexible object spring mass model. 

Each joint of the flexible object is 3-dimensional: the joint can rotate along each axis. As seen in figure \ref{fig-tube_link}, each joint frame has the $Z$-axis aligned with the link. Therefore, a bend in the tube at a joint is realized by a rotation about the $X$- and $Y$-axes and a twist in the tube is a rotation about the $Z$-axis. Because the foam is uniformly distributed for each tube, we assume that the spring constants associated with bending---i.e. rotations about the $X$ and $Y$ axes---are the same for a single tube. 

Label the torsional spring constant about the $X$-axis (alternatively $Y$ or $Z$) for the $i^{\textrm{th}}$ tube as $\kappa_{T_i,X}$ (alt, $\kappa_{T_i,Y}$ or $\kappa_{T_i,Z}$). There are 6 parameters $\rho = [\rho_1,\ldots,\rho_6]$ where 
\begin{equation}
\begin{array}{l}
\rho_1 = \kappa_{T_1,X} = \kappa_{T_1,Y}, \\
\rho_2 = \kappa_{T_1,Z}, \\
\rho_3 = \kappa_{T_2,X} = \kappa_{T_2,Y}, \\
\rho_4 = \kappa_{T_2,Z} , \\
\rho_5 = \kappa_{T_3,X} = \kappa_{T_3,Y}, \textrm{ and} \\
\rho_6 = \kappa_{T_3,Z}. 
\end{array}
\label{eq-params}
\end{equation}

The goal of this section is to identify $\rho$ by finding the $\rho$ with simulation that best matches measured data.  We compare results for when the measured data is 1) only Baxter's joint torque and joint angle with 2) Baxter's joint torque, joint angles, and vision.

\begin{figure}[!htb]
\centering
\def\svgwidth{.80\textwidth}%500pt}
\input{tube_link.pdf_tex}
\caption{Illustration of joint $i$ connecting links $i$ and $i+1$ of the flexible object.  The joint is a rotation of around the $X$, $Y$, and $Z$ axes.}
\label{fig-tube_link}
\end{figure}

\subsection{Optimal Parameter Identification \label{sec-opt}}
The goal of parameter optimization is to calculate the model parameters $\rho$ that minimize a cost functional.  The cost functional is the integral of a running cost $\ell_d(x_k,\rho)$ plus a terminal cost $m(x_{k_f},\rho)$:
\[
\min_{\rho} \Big[J_d(\rho):=\sum_{k=1}^{k_f}\ell_d(x_k,\rho) + m_d(x_{k_f},\rho)\Big]
\]
constrained to the dynamics, $x_{k+1} = f(x_k,\rho,t_k)$. Since this is a nonlinear optimal control problem, we turn to iterative methods like steepest descent to calculate a local minima. In order to apply steepest descent, we must have access the the gradient of the cost, which is given in the following Lemma from \textbf{CITE IROS PAPER}. 
\begin{lemma}
\label{lem-grad_a}
Suppose $f(x_k,\rho,t_k)$ is $\mathcal{C}^2$ with respect to $x_k$ and $\rho$.  Let $A_k$ and $B_k$ form the linearization of $f$, Eq.(\ref{eq-lin_fk}), and assume $f_k$ exists.  Then,
\begin{equation}
\nabla J_d(\rho) = \sum_{k = 1}^{k_f}\lambda_kB_{k-1} +\frac{\partial}{\partial \rho}\ell_d(x_k,\rho) + \frac{\partial}{\partial \rho}m_d(x_{k_f},\rho)
\label{eq-DJa}
\end{equation}
where $\lambda_k$ is the solution to the backward one-step mapping
\begin{equation}
\lambda_k = \lambda_{k+1}A_{k} + \frac{\partial}{\partial x_{k}}\ell_d(x_{k},\rho) 
\label{eq-lambda}
\end{equation}
starting from $\lambda_{k_f} = \frac{\partial}{\partial x_{k_f}}\ell(x_{k_f},\rho) + \frac{\partial}{\partial x_{k_f}}m_d(x_{k_f},\rho)$.  
\end{lemma}

It is worth noting that $f_k$ is not gauranteed to exist, but its existance can be checked using the Implicit Function Theorem. \textbf{CITE JARVIS} shows a couple of scenarios where such singularities occur.  Also, the gradient and Hessian for optimal parameter identification in continuous time can be found in \cite{miller_murphey}.

The steepest descent direction is $-\nabla J_d(\rho)$ and the steepest descent algorithm can be applied \textbf{cite kelley; luenberger}.

\section{Identification for Example}
The parameters to be identified are the spring constants of the flexible object given by the six dimensional $\rho$.  The identification calculates the value $\rho$ with simulation that best matches the measured data. We do the matching for two sets of measured data.  The first is just Baxter's arm joint torque and joint angle measurements while the second also includes vision (see Section XXXX).  

\subsection{Without Vision}
Without vision, the only measurements are Baxter's arm joint torques and angles.  Since Baxter is only in contact with the object at its end effector, the robot can only measure the flexible object's movement at that single point. The cost $J_d(\rho)$ for parameters $\rho$ is chosen to compare the position of Baxter's end effector in space between the simulation and the measured.  Label $w_k(\rho)$ as this simulated end effector's position at time $t_k$ for parameters $\rho$ and $\overline{w}_k$ as this measured position at $t_k$.  Set $\epsilon_k := w_k(\rho)-\overline{w}_k$.  The cost $J_d$ is defined by the running cost $\ell_d(q_k,\rho)$ and the terminal cost $m_d(q_{k_f},\rho)$, set as
\[
\ell_d(q_k,\rho) = \epsilon_k^T\epsilon_k \textrm{ and } m_d(q_{k_f},\rho) = \epsilon_{k_f}^T\epsilon_{k_f}.
\]
We calculate the locally optimal parameters $\rho^\star$ using steepest descent with gradient calculated in Section XXXXX. There is an inequality constraint that each parameter $\rho_i>0$, $i = 1,\ldots,6$. We seed the interative optimization with an initial guess of $\rho = [3, 3, 3, 3, 3, 3]^T$.  %#At each iteration of steepest descent, an Armijo line search updates the parameters by choosing a distance to step in the direction of the negative gradient.  We used Armijo parameters $\alpha = \beta = 0.4$ \cite{armijo}.

The optimization results in $\rho^\star = [23.780,  0.000 , 18.357 , 11.103 , 3.200,  3.059]^T$. Refer to Eq.(\ref{eq-params}) to compare which parameters correspond to which spring constants. 

\emph{Remarks on the results}
\begin{itemize}
\item The spring constant $\kappa_{T_1,Z} = \rho^\star_2 = 0$ is likely due to attempting to identify with insufficiently disparate measurements. Since the only measurement location is at the tip of $T_2$, it is possible that a continuum of model parameters could have equal quality matching the movement of the single measurement location---or at least nearly equal quality up to measurement noise. As such, the found optimal parameters are likely a result to the choice of cost, indicating that the current identification is overly sensitive to noise.
\item The final two parameters, $\kappa_{T_3,X} = \kappa_{T_3,Y} = \rho^\star_5 = 3.200$, and $\kappa_{T_3,Z} = \rho^\star_6 = 3.059$ are nearly the value of their initial guess to the optimization. These two parameters specify the spring constants of the free, ungrasped branch. While the free branch's movement affects the movement of the grip location, it's impact is likely insignificant compared to the movement of the rest of the object and is reflected by an insensitivity in the optimization.
\end{itemize}
Ultimately, the flexible object identification as set up here with a single point of measurement is inadequate. We turn to vision next to improve identification quality.

\subsection{With Vision}
With vision, the motion of more locations on the flexible object can be measured. However, as discussed in Section XXXXX, our vision measurements arrive at irregular intervals and sometimes of dubious quality. Fortunately, not every discrete time $t_k$ for which Baxter publishes its measurements---i.e. every $0.01$ seconds---is needed to improve identification from the without vision situation.  

The following is the process for which we choose which vision measurements are of good enough quality to be used in the identification: The fitting through the program Eq.(\ref{eq-fit_prog}) can be of poor quality. A poorer quality is quantified by a greater $d(p,L_{model}(q_o^\star))$ value for an optimal fit $q_o^\star$ with $p\in G_{processed}$. Specify the tolerance $d_{max}>0$ and keep only fits such that $d(p,L_{model}(q_o^\star))<d_{max}$. Label these fits as $q_o^\star(s)$ where $s_i\in\tau$ is the timing of the vision capture and $\tau$ is the collection of these times. These $s$ may not match a discrete time of the system, $t_k$. Therefore, we interpolate the collection of $q_o^\star(s)$ for the full time interval with a cubic spline. Label the interpolated points as $q_{o,interp}^\star[0,t_f]$. In the parameter identification, the cost will only depend on the $q_{o,interp}^\star$ evaluated at the times $t_k$ nearest the times $\tau$. .............. XXXXXXXXXXXX


\section{Planning}
\begin{enumerate}
\item Goal: calculate torques and state trajectory that moves the other end of the flexible-Y to a desired point in space.
\item Optimal control stuff.
\item Results.
\end{enumerate}

\section{Discussion / Conclusion}


\bibliographystyle{plain}
\bibliography{ISER2014_cites}

\end{document}
